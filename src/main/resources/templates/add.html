<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${student.studentId == null ? 'Add Student' : 'Edit Student'}">Student Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
			background: #f4f6f9;
			font-family: 'Segoe UI', sans-serif; 
		}
        .card { 
			border-radius: 16px; 
			box-shadow: 0 6px 18px rgba(0,0,0,0.1); 
		}
        .card-header {
			 background: linear-gradient(90deg, #0062E6, #33AEFF); 
			 color: white; border-radius: 16px 16px 0 0; 
		 }
        .btn-submit { 
			background: #33AEFF;
			 border: none;
			 color: #fff; font-weight: 500;
		  }
        .btn-submit:hover {
			 background: #0062E6;
		  }
        .checkbox-group {
			 max-height: 150px; 
			 overflow-y: auto; 
			 border: 1px solid #ddd; 
			 padding: 10px; 
			 border-radius: 8px; 
			 background: #fff; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
	        <div>
		        <a th:href="@{/admin/dashboard}" class="btn btn-outline-primary rounded-pill px-3 me-3 mb-4">
		                ⬅ Dashboard
		        </a>
		    </div>
        		<div th:if="${errorMessage}" class="alert alert-danger">
				    <p th:text="${errorMessage}"></p>
				</div>
            <div class="card">
            	
                <div class="card-header">
                    <h4 class="mb-0" th:text="${student.studentId == null ? '➕ Add New Student' : '✏️ Edit Student'}"></h4>
                </div>
                <div class="card-body">
                    <form th:action="@{${student.studentId} == null ? '/admin/student/register' : '/admin/student/updating'}"
                          method="post" th:object="${student}" id="studentForm" >
                        <input type="hidden" th:field="*{studentId}">

                        <!-- Name -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" id="firstName" th:field="*{firstName}" 
                                placeholder ="Enter First name"
                                class="form-control" required>
       		                    <span class="text-danger" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}"></span>
       		                    <span class="text-danger" id="firstNameError"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" id="lastName" th:field="*{lastName}" 
                                placeholder ="Enter last name"
                                class="form-control" required>
                                <span class="text-danger" th:if="${#fields.hasErrors('lastName')}" th:errors="*{lastName}"></span>
                                <span class="text-danger" id="lastNameError"></span>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" th:field="*{email}" 
                            placeholder ="Enter email address"
                            class="form-control" required>
                        	<span class="text-danger"  th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></span>
                        	<span class="text-danger" id="emailError"></span>
						</div>

                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                             
                            <!-- pattern="\d{10}" title="Phone Number must be of 10 digits"  -->
                            <input type="text" maxlength="10"
                             th:field="*{phoneNumber}" id="phoneNumber" 
                             placeholder ="Enter phone number"
                             class="form-control" required>
                        	<span class="text-danger" th:if="${#fields.hasErrors('phoneNumber')}" th:errors="*{phoneNumber}"></span>
                        	<span class="text-danger" id="phoneNumberError"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <!--  <input type="text" th:field="*{address}" class="form-control" required> -->
                            <textarea name="address" id="address" maxlength="100" 
                            placeholder ="Enter full address"
                            th:field="*{address}" class="form-control" required></textarea>
		                    <span class="text-danger"  th:if="${#fields.hasErrors('address')}" th:errors="*{address}"></span>                        
                        	<span class="text-danger" id="addressError"></span>
                        </div>

                        <!-- Year & Gender -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Year</label>
                                <input type="number" th:field="*{year}" 
                                placeholder ="Enter admission year..."
                                class="form-control" id="year" name="year" min="2000" max="2025" step="1" required>
                            	<span class="text-danger"  th:if="${#fields.hasErrors('year')}" th:errors="*{year}"></span>
                            	<span class="text-danger" id="yearError"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gender</label>
                                <select th:field="*{gender}" id="gender" class="form-select" required>
                                    <option value="">-- Select Gender --</option>
                                    <option value="MALE">Male</option>
                                    <option value="FEMALE">Female</option>
                                    <option value="OTHER">Other</option>
                                </select>
                                <span class="text-danger"  th:if="${#fields.hasErrors('gender')}" th:errors="*{gender}"></span>
                                <span class="text-danger" id="genderError"></span>
                            </div>
                        </div>

                        <!-- DOB -->
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" id="dob" th:field="*{dob}" class="form-control">
                        	<span class="text-danger"  th:if="${#fields.hasErrors('dob')}" th:errors="*{dob}"></span>
                        	<span class="text-danger" id="dobError"></span>
                        </div>
                        
                        <!-- Department -->
						<div class="mb-3">
						    <label>Department</label>
						    <select id="department" th:field="*{departmentId}" class="form-select">
						        <option value="">-- Select Department --</option>
						        <th:block th:each="dept : ${departments}">
						            <option th:value="${dept.departmentId}" th:text="${dept.name}"
						                 th:selected="${dept.departmentId == student.departmentId}"></option> <!-- ⭐ Preselect department for Edit -->
						        </th:block>
						    </select>
						    
						</div>
						
						<!-- Courses -->
						<div class="mb-3">
						    <label>Courses</label>
						    <div id="courses" class="checkbox-group"></div> <!-- ⭐ Added class checkbox-group for styling -->
						
						</div>
						
						<!-- Subjects -->
						<div class="mb-3">
						    <label>Subjects</label>
						    <div id="subjects" class="checkbox-group"></div>
						    
						</div>

                        <!-- Submit & Cancel -->
                        <button type="submit" id="submit" class="btn btn-submit">
                            <span th:text="${student.studentId == null ? 'Add Student' : 'Update Student'}"></span>
                        </button>
                        <a th:href="@{/admin/student/all}" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    var selectedCourseIds = /*[[${student.courseIds}]]*/ [];   
    var selectedSubjectIds = /*[[${student.subjectIds}]]*/ []; 
    // ★ Normalize IDs to string to avoid type mismatch
    selectedCourseIds = selectedCourseIds.map(String);          
    selectedSubjectIds = selectedSubjectIds.map(String);        
    console.log("Pre-selected courses:", selectedCourseIds);
    console.log("Pre-selected subjects:", selectedSubjectIds);
/*]]>*/
</script>
<script th:src="@{/student.js}"></script>

<!-- jQuery Validation -->
<script>
$(document).ready(function () {

    // First Name
    $("#firstName").on("input", function () {
        let value = $(this).val().trim();
        $("#firstNameError").text(value.length < 2 ? "First name must be at least 2 characters" : "");
    });

    // Last Name
    $("#lastName").on("input", function () {
        let value = $(this).val().trim();
        $("#lastNameError").text(value.length < 2 ? "Last name must be at least 2 characters" : "");
    });

    // Email 
    $("#email").on("input", function () {
        let value = $(this).val().trim();
        if (value.length === 0) {
            $("#emailError").text("Email is required");
            return;
        }
        let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        $("#emailError").text(!emailPattern.test(value) ? "Please enter a valid email address" : "");
    });

    // Phone
    $("#phoneNumber").on("input", function () {
        let phonePattern = /^\d{10}$/;
        let value = $(this).val().trim();
        if (value.length === 0) {
            $("#phoneNumberError").text("Phone number is required");
        } else {
            $("#phoneNumberError").text(!phonePattern.test(value) ? "Phone number must be exactly 10 digits" : "");
        }
    });

    // Address
    $("#address").on("input", function () {
        let value = $(this).val().trim();
        $("#addressError").text(value.length < 10 ? "Address must be at least 10 characters" : "");
    });

    // Year
    $("#year").on("input", function () {
        let year = parseInt($(this).val());
        if (isNaN(year)) {
            $("#yearError").text("Year is required");
        } else {
            $("#yearError").text((year < 2000 || year > 2025) ? "Year must be between 2000 and 2025" : "");
        }
    });

    // Gender
    $("#gender").on("change", function () {
        $("#genderError").text($(this).val() === "" ? "Please select gender" : "");
    });

    // DOB
    $("#dob").on("change input", function () {
        $("#dobError").text($(this).val() === "" ? "Please select date of birth" : "");
    });


    // On Form Submit
    $("#studentForm").on("submit", function (e) {

        let hasError = false;
        $(".text-danger").each(function () {
            // Only count real errors (ignore hidden/cleared ones)
            let errorText = $(this).text().replace(/\s+/g, " ").trim();
            if (errorText.length > 0) {
                hasError = true;
            }
        });

        if (hasError) {
            e.preventDefault();
            alert("Please fix errors before submitting.");
        }
    });

});


</script>

</body>
</html>
